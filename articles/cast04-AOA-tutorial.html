<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CAST">
<title>4. Area of applicability of spatial prediction models • CAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="4. Area of applicability of spatial prediction models">
<meta property="og:description" content="CAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cast01-CAST-intro.html">1. Introduction to CAST 1.0.0</a>
    <a class="dropdown-item" href="../articles/cast02-plotgeodist.html">2. Visualization of nearest neighbor distance distributions</a>
    <a class="dropdown-item" href="../articles/cast03-CV.html">3. Nearest neighbor distance matching Cross-validation in CAST</a>
    <a class="dropdown-item" href="../articles/cast04-AOA-tutorial.html">4. Area of applicability of spatial prediction models</a>
    <a class="dropdown-item" href="../articles/cast05-parallel.html">5. Improve computation time of CAST methods</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/HannaMeyer/CAST/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>4. Area of applicability of spatial prediction models</h1>
                        <h4 data-toc-skip class="author">Hanna
Meyer</h4>
            
            <h4 data-toc-skip class="date">2024-04-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/HannaMeyer/CAST/blob/HEAD/vignettes/cast04-AOA-tutorial.Rmd" class="external-link"><code>vignettes/cast04-AOA-tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>cast04-AOA-tutorial.Rmd</code></div>
    </div>

    
    
<hr>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In spatial predictive mapping, models are often applied to make
predictions far beyond sampling locations (i.e. field observations used
to map a variable even on a global scale), where new locations might
considerably differ in their environmental properties. However, areas in
the predictor space without support of training data are problematic.
The model has not been enabled to learn about relationships in these
environments and predictions for such areas have to be considered highly
uncertain.</p>
<p>In CAST, we implement the methodology described in <a href="https://doi.org/10.1111/2041-210X.13650" class="external-link">Meyer&amp;Pebesma
(2021)</a> to estimate the “area of applicability” (AOA) of (spatial)
prediction models. The AOA is defined as the area where we enabled the
model to learn about relationships based on the training data, and where
the estimated cross-validation performance holds. To delineate the AOA,
first an dissimilarity index (DI) is calculated that is based on
distances to the training data in the multidimensional predictor
variable space. To account for relevance of predictor variables
responsible for prediction patterns we weight variables by the
model-derived importance scores prior to distance calculation. The AOA
is then derived by applying a threshold based on the DI observed in the
training data using cross-validation.</p>
<p>This tutorial shows an example of how to estimate the area of
applicability of spatial prediction models.</p>
<p>For further information see: Meyer, H., &amp; Pebesma, E. (2021).
Predicting into unknown space? Estimating the area of applicability of
spatial prediction models. Methods in Ecology and Evolution, 12, 1620–
1633. [<a href="https://doi.org/10.1111/2041-210X.13650" class="external-link uri">https://doi.org/10.1111/2041-210X.13650</a>]</p>
<div class="section level4">
<h4 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h4>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HannaMeyer/CAST" class="external-link">CAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-1-using-simulated-data">Example 1: Using simulated data<a class="anchor" aria-label="anchor" href="#example-1-using-simulated-data"></a>
</h2>
<div class="section level3">
<h3 id="get-data">Get data<a class="anchor" aria-label="anchor" href="#get-data"></a>
</h3>
<div class="section level4">
<h4 id="generate-predictors">Generate Predictors<a class="anchor" aria-label="anchor" href="#generate-predictors"></a>
</h4>
<p>As predictor variables, a set of bioclimatic variables are used (<a href="https://www.worldclim.org" class="external-link uri">https://www.worldclim.org</a>). For this tutorial, they have
been originally downloaded using the getData function from the raster
package but cropped to an area in central Europe. The cropped data are
provided in the CAST package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,<span class="st">"bioclim.tif"</span>,package<span class="op">=</span><span class="st">"CAST"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">predictors</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-3-1.png" width="847.68"></p>
</div>
<div class="section level4">
<h4 id="generate-response">Generate Response<a class="anchor" aria-label="anchor" href="#generate-response"></a>
</h4>
<p>To be able to test the reliability of the method, we’re using a
simulated prediction task. We therefore simulate a virtual response
variable from the bioclimatic variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_random_response</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">raster</span>, <span class="va">predictornames</span> <span class="op">=</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, <span class="va">seed</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">operands_1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"+"</span>, <span class="st">"-"</span>, <span class="st">"*"</span>, <span class="st">"/"</span><span class="op">)</span></span>
<span>  <span class="va">operands_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"^1"</span>,<span class="st">"^2"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">expression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">predictornames</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># assign random power to predictors</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>  <span class="va">expression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">expression</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">operands_2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">predictornames</span><span class="op">)</span>,</span>
<span>replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                      sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># assign random math function between predictors (expect after the last one)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>  <span class="va">expression</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">expression</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">expression</span><span class="op">[</span><span class="op">-</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">expression</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                                           <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">operands_1</span>,</span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">predictornames</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                                           sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">expression</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># collapse</span></span>
<span>  <span class="va">e</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"raster$"</span>, <span class="va">expression</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">response</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">e</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"response"</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">generate_random_response</span> <span class="op">(</span><span class="va">predictors</span>, seed <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "bio2^1 * bio5^1 + bio10^2 - bio13^2 / bio14^2 / bio19^1"</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">response</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"virtual response"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-5-1.png" width="847.68"></p>
</div>
<div class="section level4">
<h4 id="simulate-sampling-locations">Simulate sampling locations<a class="anchor" aria-label="anchor" href="#simulate-sampling-locations"></a>
</h4>
<p>To simulate a typical prediction task, field sampling locations are
randomly selected. Here, we randomly select 20 points. Note that this is
a very small data set, but used here to avoid long computation
times.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="va">predictors</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.polygons.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">samplepoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">mask</span>,<span class="fl">20</span>,<span class="st">"random"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">response</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">samplepoints</span>,col<span class="op">=</span><span class="st">"red"</span>,add<span class="op">=</span><span class="cn">T</span>,pch<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-7-1.png" width="847.68"></p>
</div>
</div>
<div class="section level3">
<h3 id="model-training">Model training<a class="anchor" aria-label="anchor" href="#model-training"></a>
</h3>
<p>Next, a machine learning algorithm will be applied to learn the
relationships between predictors and response.</p>
<div class="section level4">
<h4 id="prepare-data">Prepare data<a class="anchor" aria-label="anchor" href="#prepare-data"></a>
</h4>
<p>Therefore, predictors and response are extracted for the sampling
locations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">predictors</span>,<span class="va">samplepoints</span>,na.rm<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">trainDat</span><span class="op">$</span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">response</span>,<span class="va">samplepoints</span>,na.rm<span class="op">=</span><span class="cn">FALSE</span>, ID<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">response</span></span>
<span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="train-the-model">Train the model<a class="anchor" aria-label="anchor" href="#train-the-model"></a>
</h4>
<p>Random Forest is applied here as machine learning algorithm (others
can be used as well, as long as variable importance is returned). The
model is validated by default cross-validation to estimate the
prediction error.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">]</span>,</span>
<span>               <span class="va">trainDat</span><span class="op">$</span><span class="va">response</span>,</span>
<span>               method<span class="op">=</span><span class="st">"rf"</span>,</span>
<span>               importance<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>               trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 20 samples</span></span>
<span><span class="co">##  6 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Cross-Validated (10 fold) </span></span>
<span><span class="co">## Summary of sample sizes: 18, 18, 18, 18, 18, 18, ... </span></span>
<span><span class="co">## Resampling results across tuning parameters:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   mtry  RMSE      Rsquared  MAE     </span></span>
<span><span class="co">##   2     3854.481  1         3310.203</span></span>
<span><span class="co">##   4     3084.764  1         2675.126</span></span>
<span><span class="co">##   6     2960.314  1         2571.475</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## RMSE was used to select the optimal model using the smallest value.</span></span>
<span><span class="co">## The final value used for the model was mtry = 6.</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="variable-importance">Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance"></a>
</h4>
<p>The estimation of the AOA will require the importance of the
individual predictor variables.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html" class="external-link">varImp</a></span><span class="op">(</span><span class="va">model</span>,scale <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-10-1.png" width="847.68"></p>
</div>
<div class="section level4">
<h4 id="predict-and-calculate-error">Predict and calculate error<a class="anchor" aria-label="anchor" href="#predict-and-calculate-error"></a>
</h4>
<p>The trained model is then used to make predictions for the entire
area of interest. Since a simulated area-wide response is used, it’s
possible in this tutorial to compare the predictions with the true
reference.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">predictors</span>,<span class="va">model</span>,na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">truediff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">-</span><span class="va">response</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">prediction</span>,<span class="va">response</span><span class="op">)</span><span class="op">)</span>,main<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prediction"</span>,<span class="st">"reference"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-11-1.png" width="847.68"></p>
</div>
</div>
<div class="section level3">
<h3 id="aoa-and-lpd-calculation">AOA and LPD calculation<a class="anchor" aria-label="anchor" href="#aoa-and-lpd-calculation"></a>
</h3>
<p>The visualization above shows the predictions made by the model. In
the next step, the DI, LPD and AOA will be calculated. Note that it is
possible to calculate the AOA without calculating the LPD, which can be
very time consuming (arg: <code>LPD = FALSE</code>).</p>
<p>The AOA calculation takes the model as input to extract the
importance of the predictors, used as weights in multidimensional
distance calculation. Note that the AOA can also be calculated without a
trained model (i.e. using training data and new data only). In this case
all predictor variables are treated equally important (unless weights
are given in form of a table).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AOA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="va">model</span>, LPD <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "aoa"</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "parameters" "DI"         "AOA"        "LPD"</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DI:</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 102, 123, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 14075.98, 14075.98  (x, y)</span></span>
<span><span class="co">## extent      : 3496791, 5228136, 2143336, 3579086  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## varname     : bioclim </span></span>
<span><span class="co">## name        :       DI </span></span>
<span><span class="co">## min value   : 0.000000 </span></span>
<span><span class="co">## max value   : 3.408739 </span></span>
<span><span class="co">## LPD:</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 102, 123, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 14075.98, 14075.98  (x, y)</span></span>
<span><span class="co">## extent      : 3496791, 5228136, 2143336, 3579086  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## varname     : bioclim </span></span>
<span><span class="co">## name        : LPD </span></span>
<span><span class="co">## min value   :   0 </span></span>
<span><span class="co">## max value   :   9 </span></span>
<span><span class="co">## AOA:</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 102, 123, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 14075.98, 14075.98  (x, y)</span></span>
<span><span class="co">## extent      : 3496791, 5228136, 2143336, 3579086  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## varname     : bioclim </span></span>
<span><span class="co">## name        : AOA </span></span>
<span><span class="co">## min value   :   0 </span></span>
<span><span class="co">## max value   :   1 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Predictor Weights:</span></span>
<span><span class="co">##       bio2     bio5    bio10   bio13 bio14 bio19</span></span>
<span><span class="co">## 1 3.746582 17.92456 17.04888 2.15925     0     0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## AOA Threshold: 0.3221291</span></span></code></pre>
<p>Plotting the <code>aoa</code> object shows the distribution of DI
values within the training data and the DI of the new data.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-13-1.png" width="847.68">
The most important output of the <code>aoa</code> function are three
raster data sets: The first is the DI that is the normalized and
weighted minimum distance to a nearest training data point divided by
the average distance within the training data. The second is the AOA
which is derived from the DI by using a threshold. The threshold is the
(outlier-removed) maximum DI observed in the training data where the DI
of the training data is calculated by considering the cross-validation
folds. The last is the LPD that is an absolute count of training data
points, that are within the AOA threshold for a new prediction location.
An LPD of <code>0</code> therefore signifies a prediction location
outside the AOA and <code>&gt;1</code> inside the AOA. The specific LPD
values give a good indication about the coverage by similar training
data for a new prediction location. The used threshold and all relevant
information about the DI and LPD of the training data is returned in the
<code>parameters</code> list entry.</p>
<p>We can plot the DI and LPD as well as predictions within the AOA:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">truediff</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"true prediction error"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">DI</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"DI"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">LPD</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"LPD"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction</span>, col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"prediction for AOA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">AOA</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">T</span>,plg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topleft"</span>,box.col<span class="op">=</span><span class="st">"black"</span>,bty<span class="op">=</span><span class="st">"o"</span>,title<span class="op">=</span><span class="st">"AOA"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-14-1.png" width="50%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-14-2.png" width="50%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-14-3.png" width="50%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-14-4.png" width="50%"></p>
<p>The patterns in the DI and LPD are in general agreement with the true
prediction error. Very high DI values are present in the Alps, as they
have not been covered by training data but feature very distinct
environmental conditions. Since the DI values for these areas are above
the threshold, we regard this area as outside the AOA.</p>
</div>
<div class="section level3">
<h3 id="aoa-for-spatially-clustered-data">AOA for spatially clustered data?<a class="anchor" aria-label="anchor" href="#aoa-for-spatially-clustered-data"></a>
</h3>
<p>The example above had randomly distributed training samples. However,
sampling locations might also be highly clustered in space. In this
case, the random cross-validation is not meaningful (see e.g. <a href="https://doi.org/10.1016/j.envsoft.2017.12.001" class="external-link">Meyer et
al. 2018</a>, <a href="https://doi.org/10.1016/j.ecolmodel.2019.108815" class="external-link">Meyer et
al. 2019</a>, <a href="https://doi.org/10.1111/2041-210X.13107" class="external-link">Valavi
et al. 2019</a>, <a href="https://doi.org/10.1111/ecog.02881" class="external-link">Roberts et
al. 2018</a>, <a href="https://doi.org/10.1080/13658816.2017.1346255" class="external-link">Pohjankukka et
al. 2017</a>, <a href="https://CRAN.R-project.org/package=sperrorest" class="external-link">Brenning
2012</a>)</p>
<p>A random cross-validation in this case would lead to a apparently
high prediction performance, but this would only apply to a very small
AOA, because the threshold on the DI is based in distance to a nearest
data point within the training data (which is usually very small when
data are clustered). To assess the model performance for larger areas,
cross-validation should be based on a spatial CV, e.g. a
leave-cluster-out approach (see vignette on spatial CV in this package
for a more detailed discussion on cross validation strategies), where
also the AOA estimation is based on distances to a nearest data point
not located in the same spatial cluster.</p>
<p>To show how this looks like, we use 15 spatial locations and simulate
5 data points around each location.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span></span>
<span><span class="va">samplepoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clustered_sample.html">clustered_sample</a></span><span class="op">(</span><span class="va">mask</span>,<span class="fl">75</span>,<span class="fl">15</span>,radius<span class="op">=</span><span class="fl">25000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">response</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">samplepoints</span>,col<span class="op">=</span><span class="st">"red"</span>,add<span class="op">=</span><span class="cn">T</span>,pch<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-15-1.png" width="847.68"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">predictors</span>,<span class="va">samplepoints</span>,na.rm<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">trainDat</span><span class="op">$</span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">response</span>,<span class="va">samplepoints</span>,na.rm<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">response</span></span>
<span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">trainDat</span>,<span class="va">samplepoints</span><span class="op">)</span></span>
<span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/na.omit.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">)</span></span></code></pre></div>
<p>We first train a model with (in this case) inappropriate random
cross-validation.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">model_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">]</span>,</span>
<span>               <span class="va">trainDat</span><span class="op">$</span><span class="va">response</span>,</span>
<span>               method<span class="op">=</span><span class="st">"rf"</span>,</span>
<span>               importance<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>               trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prediction_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">predictors</span>,<span class="va">model_random</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">model_random</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 75 samples</span></span>
<span><span class="co">##  6 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Cross-Validated (10 fold) </span></span>
<span><span class="co">## Summary of sample sizes: 68, 67, 68, 68, 68, 67, ... </span></span>
<span><span class="co">## Resampling results across tuning parameters:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   mtry  RMSE       Rsquared   MAE     </span></span>
<span><span class="co">##   2     1088.1729  0.9956237  790.2191</span></span>
<span><span class="co">##   4      921.1760  0.9968527  717.5578</span></span>
<span><span class="co">##   6      922.1137  0.9967308  715.7016</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## RMSE was used to select the optimal model using the smallest value.</span></span>
<span><span class="co">## The final value used for the model was mtry = 4.</span></span></code></pre>
<p>…and a model based on leave-cluster-out cross-validation.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateSpacetimeFolds.html">CreateSpacetimeFolds</a></span><span class="op">(</span><span class="va">trainDat</span>, spacevar<span class="op">=</span><span class="st">"parent"</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                 <span class="va">trainDat</span><span class="op">$</span><span class="va">response</span>,</span>
<span>                     method<span class="op">=</span><span class="st">"rf"</span>,</span>
<span>                 importance<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                 tuneGrid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span>,index<span class="op">=</span><span class="va">folds</span><span class="op">$</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 75 samples</span></span>
<span><span class="co">##  6 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Cross-Validated (10 fold) </span></span>
<span><span class="co">## Summary of sample sizes: 70, 70, 65, 70, 70, 65, ... </span></span>
<span><span class="co">## Resampling results across tuning parameters:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   mtry  RMSE      Rsquared   MAE     </span></span>
<span><span class="co">##   2     3227.421  0.9382904  2740.529</span></span>
<span><span class="co">##   3     2761.092  0.9433621  2396.941</span></span>
<span><span class="co">##   4     2677.002  0.9570317  2349.310</span></span>
<span><span class="co">##   5     2587.598  0.9486190  2282.064</span></span>
<span><span class="co">##   6     2494.756  0.9425158  2190.718</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## RMSE was used to select the optimal model using the smallest value.</span></span>
<span><span class="co">## The final value used for the model was mtry = 6.</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">predictors</span>,<span class="va">model</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The AOA is then calculated (for comparison) using the model validated
by random cross-validation, and second by taking the spatial clusters
into account and calculating the threshold based on minimum distances to
a nearest training point not located in the same cluster. This is done
in the aoa function, where the folds used for cross-validation are
automatically extracted from the model.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AOA_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="va">model</span>, LPD <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AOA_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="va">model_random</span>, LPD <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">DI</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"DI"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">LPD</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"LPD"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction</span>, col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"prediction for AOA \n(spatial CV error applies)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">AOA</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">TRUE</span>,plg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topleft"</span>,box.col<span class="op">=</span><span class="st">"black"</span>,bty<span class="op">=</span><span class="st">"o"</span>,bg <span class="op">=</span> <span class="st">'white'</span>,title<span class="op">=</span><span class="st">"AOA"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction_random</span>, col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"prediction for AOA \n(random CV error applies)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_random</span><span class="op">$</span><span class="va">AOA</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">TRUE</span>,plg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topleft"</span>,box.col<span class="op">=</span><span class="st">"black"</span>,bty<span class="op">=</span><span class="st">"o"</span>,bg <span class="op">=</span> <span class="st">'white'</span>,title<span class="op">=</span><span class="st">"AOA"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-20-1.png" width="50%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-20-2.png" width="50%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-20-3.png" width="50%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-20-4.png" width="50%"></p>
<p>Note that the AOA is much larger for the spatial CV approach.
However, the spatial cross-validation error is considerably larger,
hence also the area for which this error applies is larger. The random
cross-validation performance is very high, however, the area to which
the performance applies is small. This fact is also apparent if you plot
the <code>aoa</code> objects which will display the distributions of the
DI of the training data as well as the DI of the new data. For random CV
most of the predictionDI is larger than the AOA threshold determined by
the trainDI. Using spatial CV, the predictionDI is well within the DI of
the training sample.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_spatial</span>, variable <span class="op">=</span> <span class="st">"DI"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Spatial CV"</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_random</span>, variable <span class="op">=</span> <span class="st">"DI"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Random CV"</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-21-1.png" width="847.68"></p>
</div>
<div class="section level3">
<h3 id="comparison-prediction-error-with-model-error">Comparison prediction error with model error<a class="anchor" aria-label="anchor" href="#comparison-prediction-error-with-model-error"></a>
</h3>
<p>Since we used a simulated response variable, we can now compare the
prediction error within the AOA with the model error, assuming that the
model error applies inside the AOA but not outside.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###for the spatial CV:</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/postResample.html" class="external-link">RMSE</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>     <span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3308.808</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/postResample.html" class="external-link">RMSE</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,</span>
<span>     <span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10855.31</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="va">results</span></span></code></pre></div>
<pre><code><span><span class="co">##   mtry     RMSE  Rsquared      MAE   RMSESD RsquaredSD    MAESD</span></span>
<span><span class="co">## 1    2 3227.421 0.9382904 2740.529 2335.609 0.06774290 2168.398</span></span>
<span><span class="co">## 2    3 2761.092 0.9433621 2396.941 1823.280 0.07190124 1674.310</span></span>
<span><span class="co">## 3    4 2677.002 0.9570317 2349.310 1690.078 0.04208035 1549.323</span></span>
<span><span class="co">## 4    5 2587.598 0.9486190 2282.064 1595.276 0.05220790 1410.225</span></span>
<span><span class="co">## 5    6 2494.756 0.9425158 2190.718 1507.700 0.07431001 1289.825</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###and for the random CV:</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/postResample.html" class="external-link">RMSE</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">prediction_random</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_random</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>     <span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_random</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1365.329</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/postResample.html" class="external-link">RMSE</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">prediction_random</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_random</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>,</span>
<span>     <span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">AOA_random</span><span class="op">$</span><span class="va">AOA</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3959.685</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_random</span><span class="op">$</span><span class="va">results</span></span></code></pre></div>
<pre><code><span><span class="co">##   mtry      RMSE  Rsquared      MAE   RMSESD  RsquaredSD    MAESD</span></span>
<span><span class="co">## 1    2 1088.1729 0.9956237 790.2191 595.2632 0.004567068 407.8754</span></span>
<span><span class="co">## 2    4  921.1760 0.9968527 717.5578 437.1580 0.002792369 311.1915</span></span>
<span><span class="co">## 3    6  922.1137 0.9967308 715.7016 412.0427 0.002498990 306.1030</span></span></code></pre>
<p>The results indicate that there is a high agreement between the model
CV error (RMSE) and the true prediction RMSE. This is the case for both,
the random as well as the spatial model.</p>
</div>
<div class="section level3">
<h3 id="relationship-between-the-dilpd-and-the-performance-measure">Relationship between the DI/LPD and the performance measure<a class="anchor" aria-label="anchor" href="#relationship-between-the-dilpd-and-the-performance-measure"></a>
</h3>
<p>The relationship between error and DI or LPD can be used to limit
predictions to an area (within the AOA) where a required performance
(e.g. RMSE, R2, Kappa, Accuracy) applies. This can be done using the
result of errorProfiles which used the relationship analyzed in a window
of DI/LPD values. The corresponding model (here: shape constrained
additive models which is the default: Monotone increasing P-splines with
the dimension of the basis used to represent the smooth term is 6 and a
2nd order penalty.) can be used to estimate the performance on a pixel
level, which then allows limiting predictions using a threshold. Note
that we used a multi-purpose CV to estimate the relationship between the
DI and the RMSE here (see details in the paper).</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DI_RMSE_relation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/errorProfiles.html">errorProfiles</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">AOA_spatial</span><span class="op">$</span><span class="va">parameters</span>, multiCV<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                    window.size <span class="op">=</span> <span class="fl">5</span>, length.out <span class="op">=</span> <span class="fl">5</span>, variable <span class="op">=</span> <span class="st">"DI"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">DI_RMSE_relation</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-23-1.png" width="847.68"></p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LPD_RMSE_relation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/errorProfiles.html">errorProfiles</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">AOA_spatial</span><span class="op">$</span><span class="va">parameters</span>, multiCV<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                    window.size <span class="op">=</span> <span class="fl">5</span>, length.out <span class="op">=</span> <span class="fl">5</span>, variable <span class="op">=</span> <span class="st">"LPD"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">LPD_RMSE_relation</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-23-2.png" width="847.68"></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DI_expected_RMSE</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">DI</span>, <span class="va">DI_RMSE_relation</span><span class="op">)</span></span>
<span><span class="va">LPD_expected_RMSE</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">AOA_spatial</span><span class="op">$</span><span class="va">LPD</span>, <span class="va">LPD_RMSE_relation</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># account for multiCV changing the DI threshold</span></span>
<span><span class="va">DI_updated_AOA</span> <span class="op">=</span> <span class="va">AOA_spatial</span><span class="op">$</span><span class="va">DI</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">DI_RMSE_relation</span>, <span class="st">"AOA_threshold"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># account for multiCV changing the DI threshold</span></span>
<span><span class="va">LPD_updated_AOA</span> <span class="op">=</span> <span class="va">AOA_spatial</span><span class="op">$</span><span class="va">DI</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">LPD_RMSE_relation</span>, <span class="st">"AOA_threshold"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">DI_expected_RMSE</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"DI expected RMSE"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">DI_updated_AOA</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">TRUE</span>,plg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topleft"</span>,box.col<span class="op">=</span><span class="st">"black"</span>,bty<span class="op">=</span><span class="st">"o"</span>,bg <span class="op">=</span> <span class="st">'white'</span>,title<span class="op">=</span><span class="st">"AOA"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-23-3.png" width="847.68"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">LPD_expected_RMSE</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"LPD expected RMSE"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">LPD_updated_AOA</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">TRUE</span>,plg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topleft"</span>,box.col<span class="op">=</span><span class="st">"black"</span>,bty<span class="op">=</span><span class="st">"o"</span>,bg <span class="op">=</span> <span class="st">'white'</span>,title<span class="op">=</span><span class="st">"AOA"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-23-4.png" width="847.68"></p>
</div>
</div>
<div class="section level2">
<h2 id="example-2-a-real-world-example">Example 2: A real-world example<a class="anchor" aria-label="anchor" href="#example-2-a-real-world-example"></a>
</h2>
<p>The example above used simulated data so that it allows to analyze
the reliability of the AOA. However, a simulated area-wide response is
not available in usual prediction tasks. Therefore, as a second example
the AOA is estimated for a dataset that has point observations as a
reference only.</p>
<div class="section level3">
<h3 id="data-and-preprocessing">Data and preprocessing<a class="anchor" aria-label="anchor" href="#data-and-preprocessing"></a>
</h3>
<p>To do so, we will work with the cookfarm dataset, described in
e.g. <a href="https://www.sciencedirect.com/science/article/pii/S2211675315000251" class="external-link">Gasch
et al 2015</a>. The dataset included in CAST is a re-structured dataset.
Find more details also in the vignette “Introduction to CAST”. We will
use soil moisture (VW) as response variable here. Hence, we’re aiming at
making a spatial continuous prediction based on limited measurements
from data loggers.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">cookfarm</span><span class="op">)</span></span>
<span><span class="co"># calculate average of VW for each sampling site:</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">cookfarm</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"VW"</span>,<span class="st">"Easting"</span>,<span class="st">"Northing"</span><span class="op">)</span><span class="op">]</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">cookfarm</span><span class="op">$</span><span class="va">SOURCEID</span><span class="op">)</span><span class="op">)</span>,<span class="va">mean</span><span class="op">)</span></span>
<span><span class="co"># create sf object from the data:</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">dat</span>,coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Easting"</span>,<span class="st">"Northing"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##### Extract Predictors for the locations of the sampling points</span></span>
<span><span class="va">studyArea</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,<span class="st">"predictors_2012-03-25.tif"</span>,package<span class="op">=</span><span class="st">"CAST"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">studyArea</span><span class="op">)</span></span>
<span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">studyArea</span>,<span class="va">pts</span>,na.rm<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pts</span><span class="op">$</span><span class="va">ID</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span></span>
<span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">trainDat</span>,<span class="va">pts</span>,by.x<span class="op">=</span><span class="st">"ID"</span>,by.y<span class="op">=</span><span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="co"># The final training dataset with potential predictors and VW:</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ID      DEM      TWI  BLD       NDRE.M   NDRE.Sd     Bt Easting Northing</span></span>
<span><span class="co">## 1  1 788.1906 4.304258 1.42 -0.051189531 0.2506899 0.0000  493384  5180587</span></span>
<span><span class="co">## 2  2 788.3813 3.863605 1.29 -0.046459336 0.1754623 0.0000  493514  5180567</span></span>
<span><span class="co">## 3  3 790.5244 3.947488 1.36 -0.040845532 0.2225785 0.0000  493574  5180577</span></span>
<span><span class="co">## 4  4 775.7229 5.395786 1.55 -0.004329725 0.2099845 0.0501  493244  5180587</span></span>
<span><span class="co">## 5  5 796.7618 3.534822 1.31  0.027252737 0.2002646 0.0000  493624  5180607</span></span>
<span><span class="co">## 6  6 795.8370 3.815516 1.40 -0.123434804 0.2180606 0.0000  493694  5180607</span></span>
<span><span class="co">##   MinT_wrcc MaxT_wrcc Precip_cum  cday Precip_wrcc Group.1        VW</span></span>
<span><span class="co">## 1       1.1      36.2       10.6 15425           0  CAF003 0.2894505</span></span>
<span><span class="co">## 2       1.1      36.2       10.6 15425           0  CAF007 0.2705531</span></span>
<span><span class="co">## 3       1.1      36.2       10.6 15425           0  CAF009 0.2629683</span></span>
<span><span class="co">## 4       1.1      36.2       10.6 15425           0  CAF019 0.2993580</span></span>
<span><span class="co">## 5       1.1      36.2       10.6 15425           0  CAF031 0.2664754</span></span>
<span><span class="co">## 6       1.1      36.2       10.6 15425           0  CAF033 0.2650177</span></span>
<span><span class="co">##                   geometry</span></span>
<span><span class="co">## 1 POINT (493383.1 5180586)</span></span>
<span><span class="co">## 2 POINT (493510.7 5180568)</span></span>
<span><span class="co">## 3 POINT (493574.6 5180573)</span></span>
<span><span class="co">## 4 POINT (493246.6 5180590)</span></span>
<span><span class="co">## 5 POINT (493628.3 5180612)</span></span>
<span><span class="co">## 6 POINT (493692.2 5180610)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="model-training-and-prediction">Model training and prediction<a class="anchor" aria-label="anchor" href="#model-training-and-prediction"></a>
</h3>
<p>A set of variables is used as predictors for VW in a random Forest
model. The model is validated with a leave one out cross-validation.
Note that the model performance is very low, due to the small dataset
being used here (and for this small dataset a low ability of the
predictors to model VW).</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DEM"</span>,<span class="st">"NDRE.Sd"</span>,<span class="st">"TWI"</span>,<span class="st">"Bt"</span><span class="op">)</span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"VW"</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="va">predictors</span><span class="op">]</span>,<span class="va">trainDat</span><span class="op">[</span>,<span class="va">response</span><span class="op">]</span>,</span>
<span>               method<span class="op">=</span><span class="st">"rf"</span>,tuneLength<span class="op">=</span><span class="fl">3</span>,importance<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>               trControl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"LOOCV"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span></span></code></pre></div>
<pre><code><span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 42 samples</span></span>
<span><span class="co">##  4 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Leave-One-Out Cross-Validation </span></span>
<span><span class="co">## Summary of sample sizes: 41, 41, 41, 41, 41, 41, ... </span></span>
<span><span class="co">## Resampling results across tuning parameters:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   mtry  RMSE        Rsquared    MAE       </span></span>
<span><span class="co">##   2     0.04043599  0.02194320  0.03272203</span></span>
<span><span class="co">##   3     0.04130865  0.01657314  0.03310715</span></span>
<span><span class="co">##   4     0.04090019  0.02358726  0.03295413</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## RMSE was used to select the optimal model using the smallest value.</span></span>
<span><span class="co">## The final value used for the model was mtry = 2.</span></span></code></pre>
<div class="section level4">
<h4 id="prediction">Prediction<a class="anchor" aria-label="anchor" href="#prediction"></a>
</h4>
<p>Next, the model is used to make predictions for the entire study
area.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Predictors:</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/stretch.html" class="external-link">stretch</a></span><span class="op">(</span><span class="va">studyArea</span><span class="op">[[</span><span class="va">predictors</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-26-1.png" width="847.68"></p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#prediction:</span></span>
<span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">studyArea</span>,<span class="va">model</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="aoa-estimation">AOA estimation<a class="anchor" aria-label="anchor" href="#aoa-estimation"></a>
</h3>
<p>Next we’re limiting the predictions to the AOA. Predictions outside
the AOA should be excluded.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AOA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span><span class="va">studyArea</span>, <span class="va">model</span>, LPD <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### Plot results:</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">DI</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"DI with sampling locations (red)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pts</span>,zcol<span class="op">=</span><span class="st">"ID"</span>,col<span class="op">=</span><span class="st">"red"</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">LPD</span>,col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"LPD with sampling locations (red)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pts</span>,zcol<span class="op">=</span><span class="st">"ID"</span>,col<span class="op">=</span><span class="st">"red"</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction</span>, col<span class="op">=</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,main<span class="op">=</span><span class="st">"prediction for AOA \n(LOOCV error applies)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">AOA</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">TRUE</span>,plg<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topleft"</span>,box.col<span class="op">=</span><span class="st">"black"</span>,bty<span class="op">=</span><span class="st">"o"</span>, bg <span class="op">=</span> <span class="st">'white'</span>, title<span class="op">=</span><span class="st">"AOA"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-27-1.png" width="30%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-27-2.png" width="30%"><img src="cast04-AOA-tutorial_files/figure-html/unnamed-chunk-27-3.png" width="30%"></p>
</div>
</div>
<div class="section level2">
<h2 id="final-notes">Final notes<a class="anchor" aria-label="anchor" href="#final-notes"></a>
</h2>
<ul>
<li>The AOA is estimated based on training data and new data
(i.e. raster group of the entire area of interest). The trained model
are only used for getting the variable importance needed to weight
predictor variables. These can be given as a table either, so the
approach can be used with other packages than caret as well.</li>
<li>Knowledge on the AOA is important when predictions are used as a
baseline for decision making or subsequent environmental modelling.</li>
<li>We suggest that the AOA should be provided alongside the prediction
map and complementary to the communication of validation
performances.</li>
</ul>
<div class="section level3">
<h3 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h3>
<ul>
<li><p>Meyer, H., &amp; Pebesma, E. (2022): Machine learning-based
global maps of ecological variables and the challenge of assessing them.
Nature Communications. [<a href="https://doi.org/10.1038/s41467-022-29838-9" class="external-link uri">https://doi.org/10.1038/s41467-022-29838-9</a>]</p></li>
<li><p>Meyer, H., &amp; Pebesma, E. (2021). Predicting into unknown
space? Estimating the area of applicability of spatial prediction
models. Methods in Ecology and Evolution, 12, 1620– 1633. [<a href="https://doi.org/10.1111/2041-210X.13650" class="external-link uri">https://doi.org/10.1111/2041-210X.13650</a>]</p></li>
<li><p>Tutorial (<a href="https://youtu.be/EyP04zLe9qo" class="external-link uri">https://youtu.be/EyP04zLe9qo</a>) and Lecture (<a href="https://youtu.be/OoNH6Nl-X2s" class="external-link uri">https://youtu.be/OoNH6Nl-X2s</a>) recording from OpenGeoHub
summer school 2020 on the area of applicability. As well as talk at the
OpenGeoHub summer school 2022: <a href="https://doi.org/10.5446/59412" class="external-link uri">https://doi.org/10.5446/59412</a></p></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Hanna Meyer, Carles Milà, Marvin Ludwig, Jan Linnenbrink, Fabian Schumacher.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
