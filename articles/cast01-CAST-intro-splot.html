<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CAST">
<title>1. Introduction to CAST 1.0.0 • CAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1. Introduction to CAST 1.0.0">
<meta property="og:description" content="CAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cast01-CAST-intro-cookfarm.html">1. Introduction to CAST 0.8.1</a>
    <a class="dropdown-item" href="../articles/cast01-CAST-intro-splot.html">1. Introduction to CAST 1.0.0</a>
    <a class="dropdown-item" href="../articles/cast02-AOA-tutorial.html">2. Area of applicability of spatial prediction models</a>
    <a class="dropdown-item" href="../articles/cast03-AOA-parallel.html">3. AOA in Parallel</a>
    <a class="dropdown-item" href="../articles/cast04-plotgeodist.html">4. Visualization of nearest neighbor distance distributions</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/HannaMeyer/CAST/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>1. Introduction to CAST 1.0.0</h1>
                        <h4 data-toc-skip class="author">Hanna
Meyer</h4>
            
            <h4 data-toc-skip class="date">2023-09-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/HannaMeyer/CAST/blob/HEAD/vignettes/cast01-CAST-intro-splot.Rmd" class="external-link"><code>vignettes/cast01-CAST-intro-splot.Rmd</code></a></small>
      <div class="d-none name"><code>cast01-CAST-intro-splot.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h3>
<p>One key task in environmental science is obtaining information of
environmental variables continuously in space or in space and time,
usually based on remote sensing and limited field data. In that respect,
machine learning algorithms have been proven to be an important tool to
learn patterns in nonlinear and complex systems. However, standard
machine learning applications are not suitable for spatio-temporal data,
as they usually ignore the spatio-temporal dependencies in the data.
This becomes problematic in (at least) two aspects of predictive
modelling: Overfitted models as well as overly optimistic error
assessment (see <a href="https://www.sciencedirect.com/science/article/pii/S1364815217310976" class="external-link">Meyer
et al 2018</a> or <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304380019303230" class="external-link">Meyer
et al 2019</a> ). To approach these problems, CAST supports the
well-known caret package (<a href="https://topepo.github.io/caret/index.html" class="external-link">Kuhn 2018</a> to
provide methods designed for spatio-temporal data.</p>
<p>This tutorial shows how to set up a spatio-temporal prediction model
that includes objective and reliable error estimation. It further shows
how spatio-temporal overfitting can be detected by comparison between
validation strategies. It will be shown that certain variables are
responsible for the problem of overfitting due to spatio-temporal
autocorrelation patterns. Therefore, this tutorial also shows how to
automatically exclude variables that lead to overfitting with the aim to
improve the spatio-temporal prediction model.</p>
<p>In order to follow this tutorial, I assume that the reader is
familiar with the basics of predictive modelling nicely explained in <a href="https://doi.org/10.1007/978-1-4614-6849-3" class="external-link">Kuhn and Johnson
2013</a> as well as machine learning applications via the caret
package.</p>
</div>
<div class="section level3">
<h3 id="how-to-start">How to start<a class="anchor" aria-label="anchor" href="#how-to-start"></a>
</h3>
<p>To work with the tutorial, first install the CAST package and load
the library:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#install.packages("CAST")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HannaMeyer/CAST" class="external-link">CAST</a></span><span class="op">)</span></span></code></pre></div>
<p>If you need help, see</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/help.html" class="external-link">help</a></span><span class="op">(</span><span class="va">CAST</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-of-a-typical-spatio-temporal-prediction-task">Example of a typical spatio-temporal prediction task<a class="anchor" aria-label="anchor" href="#example-of-a-typical-spatio-temporal-prediction-task"></a>
</h2>
<p>The example prediction task for this tutorial is the following: we
have a set of data loggers distributed over a farm, and we want to map
soil moisture, based on a set of spatial and temporal predictor
variables. We will use Random Forests as a machine learning algorithm in
this tutorial.</p>
<div class="section level3">
<h3 id="description-of-the-example-dataset">Description of the example dataset<a class="anchor" aria-label="anchor" href="#description-of-the-example-dataset"></a>
</h3>
<p>To do so, we will work with data of the sPlotOpen vegetation
database. #TODO</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   PlotObservationID   GIVD_ID   Country                      Biome</span></span>
<span><span class="co">## 1              1955 SA-AR-002 Argentina Dry tropics and subtropics</span></span>
<span><span class="co">## 2              1956 SA-AR-002 Argentina Dry tropics and subtropics</span></span>
<span><span class="co">## 3              1958 SA-AR-002 Argentina Dry tropics and subtropics</span></span>
<span><span class="co">## 4              1960 SA-AR-002 Argentina Dry tropics and subtropics</span></span>
<span><span class="co">## 5              1961 SA-AR-002 Argentina Dry tropics and subtropics</span></span>
<span><span class="co">## 6              1963 SA-AR-002 Argentina Dry tropics and subtropics</span></span>
<span><span class="co">##   Species_richness    bio_1    bio_4 bio_5 bio_6    bio_8    bio_9 bio_12</span></span>
<span><span class="co">## 1               52 17.65000 463.9651  30.5   3.6 23.25000 11.70000    760</span></span>
<span><span class="co">## 2               56 17.35417 459.5525  30.1   3.5 22.91667 11.46667    731</span></span>
<span><span class="co">## 3               65 18.31667 473.3216  31.4   4.2 24.03333 12.25000    810</span></span>
<span><span class="co">## 4               50 18.04167 485.8116  31.2   4.2 23.93333 11.81667    842</span></span>
<span><span class="co">## 5               45 18.79167 478.4959  32.0   4.4 24.48333 12.65000    853</span></span>
<span><span class="co">## 6               31 18.92083 478.9594  32.2   4.5 24.61667 12.76667    842</span></span>
<span><span class="co">##   bio_13 bio_14   bio_15 elev             geometry</span></span>
<span><span class="co">## 1    119      9 68.89403  416 -63.86056, -30.29722</span></span>
<span><span class="co">## 2    115      9 68.93396  468 -63.94722, -30.37222</span></span>
<span><span class="co">## 3    129     12 66.87429  232 -63.66278, -30.37806</span></span>
<span><span class="co">## 4    140     13 65.54655  129 -63.32139, -30.98694</span></span>
<span><span class="co">## 5    134     12 68.29005  231 -63.55694, -29.89889</span></span>
<span><span class="co">## 6    133     12 68.72808  243 -63.53972, -29.75833</span></span></code></pre>
<p>To get an impression on the spatial properties of the dataset, let’s
have a look on the spatial distribution of the vegetation plots in South
America:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">[</span>,<span class="st">"Biome"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-4-1.png" width="847.68"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#...or plot the data with mapview:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview" class="external-link">mapview</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapviewOptions.html" class="external-link">mapviewOptions</a></span><span class="op">(</span>basemaps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Esri.WorldImagery"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html" class="external-link">mapview</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-training-and-prediction">Model training and prediction<a class="anchor" aria-label="anchor" href="#model-training-and-prediction"></a>
</h2>
<p>To start with, lets use this dataset to create a “default” Random
Forest model that predicts species richness based on some predictor
variables. To keep computation time at a minimum, we don’t include
hyperparameter tuning (hence mtry was set to 2) which is reasonable as
Random Forests are comparably insensitive to tuning.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio_1"</span>, <span class="st">"bio_4"</span>, <span class="st">"bio_5"</span>, <span class="st">"bio_6"</span>,</span>
<span>                <span class="st">"bio_8"</span>, <span class="st">"bio_9"</span>, <span class="st">"bio_12"</span>, <span class="st">"bio_13"</span>,</span>
<span>                <span class="st">"bio_14"</span>, <span class="st">"bio_15"</span>, <span class="st">"elev"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># to use the data for model training we have to get rid of the geometry column</span></span>
<span><span class="va">trainDat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="va">predictors</span><span class="op">]</span>,<span class="va">trainDat</span><span class="op">$</span><span class="va">Species_richness</span>,</span>
<span>               method<span class="op">=</span><span class="st">"rf"</span>,tuneGrid<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"mtry"</span><span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>               importance<span class="op">=</span><span class="cn">TRUE</span>,ntree<span class="op">=</span><span class="fl">50</span>,</span>
<span>               trControl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span>,number<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Based on the trained model we can make spatial predictions of species
richness. To do this we load a multiband raster that contains spatial
data of all predictor variables for Chile. We then apply the trained
model on this data set.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="va">predictors_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"predictors_chile.tif"</span>,package<span class="op">=</span><span class="st">"CAST"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">predictors_sp</span>,<span class="va">model</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-7-1.png" width="847.68"></p>
<p>The result is a spatially comprehensive map of the species richness
of Chile. We see that simply creating a map using machine learning and
caret is an easy task, however accurately measuring its performance is
less simple. Though the map looks good on a first sight we now have to
follow up with the question of how accurate this map is, hence we need
to ask how well the model is able to map species richness.</p>
<p>From a visible inspection it is noticeable that the model produces a
strange linear feature in the south west of Chile which looks
suspicious. But let’s come back to this later and first focus on a
statistical validation of the model.</p>
</div>
<div class="section level2">
<h2 id="cross-validation-strategies-for-spatio-temporal-data">Cross validation strategies for spatio-temporal data<a class="anchor" aria-label="anchor" href="#cross-validation-strategies-for-spatio-temporal-data"></a>
</h2>
<p>Among validation strategies, k-fold cross validation (CV) is popular
to estimate the performance of the model in view to data that have not
been used for model training. During CV, models are repeatedly trained
(k models) and in each model run, the data of one fold are put to the
side and are not used for model training but for model validation. In
this way, the performance of the model can be estimated using data that
have not been included in the model training.</p>
<div class="section level3">
<h3 id="the-standard-approach-random-k-fold-cv">The Standard approach: Random k-fold CV<a class="anchor" aria-label="anchor" href="#the-standard-approach-random-k-fold-cv"></a>
</h3>
<p>In the example above we used a random k-fold CV that we defined in
caret’s trainControl argument. More specifically, we used a random
3-fold CV. Hence, the data points in our dataset were RANDOMLY split
into 3 folds. To assess the performance of the model let’s have a look
on the output of the Random CV:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span></span></code></pre></div>
<pre><code><span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 703 samples</span></span>
<span><span class="co">##  11 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Cross-Validated (3 fold) </span></span>
<span><span class="co">## Summary of sample sizes: 470, 469, 467 </span></span>
<span><span class="co">## Resampling results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   RMSE      Rsquared   MAE     </span></span>
<span><span class="co">##   25.75544  0.6651004  15.08417</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Tuning parameter 'mtry' was held constant at a value of 2</span></span></code></pre>
<p>We see that species richness could be modelled with a R² of 0.66
which indicates a good fit of the data. Sounds good, but unfortunately,
the random k fold CV does not give us a good indication for the map
accuracy. Random k-fold CV means that each of the three folds (with the
highest certainty) contains data points from each known location.
Therefore, a random CV cannot indicate the ability of the model to make
predictions beyond the location of the training data (i.e. to map
species richness). Since our aim is to map species richness, we rather
need to perform a target-oriented validation which validates the model
in view to spatial mapping.</p>
</div>
<div class="section level3">
<h3 id="target-oriented-validation">Target-oriented validation<a class="anchor" aria-label="anchor" href="#target-oriented-validation"></a>
</h3>
<p>We are not interested in the model performance in view to random
subsets of our vegetation plots, but we need to know how well the model
is able to make predictions for areas without reference samples. To find
this out, we need to repeatedly leave larger spatial regions of one or
more vegetation plots out and use them as test data during CV.</p>
<p>To do this we first need to create meaningful folds rather than
random folds. CAST’s function “CreateSpaceTimeFolds” is designed to
provide index arguments used by caret’s trainControl. The index defines
which data points are used for model training during each model run and
reversely defines which data points are held back. Hence, using the
index argument we can account for the dependencies in the data by
leaving the complete data from one or more regions out (LLO CV), from
one or more time steps out (LTO CV) or from data loggers and time steps
out (LLTO CV). In this example we’re focusing on LLO CV, therefore we
use the column “Biome” to define the location of a data logger and split
the data into folds using this information. Analog to the random CV we
split the data into five folds, hence five model runs are performed each
leaving one fifth of all data loggers out for validation.</p>
<p>Note that several suggestions of spatial CV exist. What we call LLO
here is just a simple example. See references in <a href="https://www.nature.com/articles/s41467-022-29838-9" class="external-link">Meyer and
Pebesma 2022</a> for some examples and have a look at <a href="https://doi.org/10.1111/2041-210X.13851" class="external-link">Mila et al 2022</a> for
the methodology implemented in the CAST function nndm.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateSpacetimeFolds.html">CreateSpacetimeFolds</a></span><span class="op">(</span><span class="va">trainDat</span>,spacevar <span class="op">=</span> <span class="st">"Biome"</span>,</span>
<span>                                k<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">model_LLO</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="va">predictors</span><span class="op">]</span>,<span class="va">trainDat</span><span class="op">$</span><span class="va">Species_richness</span>,</span>
<span>                   method<span class="op">=</span><span class="st">"rf"</span>,tuneGrid<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"mtry"</span><span class="op">=</span><span class="fl">2</span><span class="op">)</span>, importance<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                   trControl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span>,</span>
<span>                                          index <span class="op">=</span> <span class="va">indices</span><span class="op">$</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model_LLO</span></span></code></pre></div>
<pre><code><span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 703 samples</span></span>
<span><span class="co">##  11 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Cross-Validated (10 fold) </span></span>
<span><span class="co">## Summary of sample sizes: 532, 244, 630 </span></span>
<span><span class="co">## Resampling results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   RMSE      Rsquared   MAE     </span></span>
<span><span class="co">##   28.34083  0.3674409  18.11776</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Tuning parameter 'mtry' was held constant at a value of 2</span></span></code></pre>
<p>By inspecting the output of the model, we see that in view to new
locations, the R² is only 0.36 so the performance is much lower than
expected from the random CV (R² = 0.66).</p>
<p>Apparently, there is considerable overfitting in the model, causing a
good random performance but a poor performance in view to new locations.
This might partly be attributed to the choice of variables where we must
suspect that certain variables are misinterpreted by the model (see <a href="https://www.sciencedirect.com/science/article/pii/S1364815217310976" class="external-link">Meyer
et al 2018</a> or [talk at the OpenGeoHub summer school 2019] (<a href="https://www.youtube.com/watch?v=mkHlmYEzsVQ" class="external-link uri">https://www.youtube.com/watch?v=mkHlmYEzsVQ</a>)).</p>
<p>Let’s have a look at the variable importance ranking of Random
Forest. Assuming that certain variables are misinterpreted by the
algorithm we should be able to produce a higher LLO performance when
such variables are removed. Let’s see if this is true…</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html" class="external-link">varImp</a></span><span class="op">(</span><span class="va">model_LLO</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-10-1.png" width="847.68"></p>
</div>
</div>
<div class="section level2">
<h2 id="removing-variables-that-cause-overfitting">Removing variables that cause overfitting<a class="anchor" aria-label="anchor" href="#removing-variables-that-cause-overfitting"></a>
</h2>
<p>CAST’s forward feature selection (ffs) selects variables that make
sense in view to the selected CV method and excludes those which are
counterproductive (or meaningless) in view to the selected CV method.
When we use LLO as CV method, ffs selects variables that lead in
combination to the highest LLO performance (i.e. the best spatial
model). All variables that have no spatial meaning or are even
counterproductive won’t improve or even reduce the LLO performance and
are therefore excluded from the model by the ffs.</p>
<p>ffs is doing this job by first training models using all possible
pairs of two predictor variables. The best model of these initial models
is kept. On the basis of this best model the predictor variables are
iterativly increased and each of the remaining variables is tested for
its improvement of the currently best model. The process stops if none
of the remaining variables increases the model performance when added to
the current best model.</p>
<p>So let’s run the ffs on our case study using R² as a metric to select
the optimal variables. This process will take 1-2 minutes…</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">ffsmodel_LLO</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs.html">ffs</a></span><span class="op">(</span><span class="va">trainDat</span><span class="op">[</span>,<span class="va">predictors</span><span class="op">]</span>,<span class="va">trainDat</span><span class="op">$</span><span class="va">Species_richness</span>,metric<span class="op">=</span><span class="st">"Rsquared"</span>,</span>
<span>                    method<span class="op">=</span><span class="st">"rf"</span>, tuneGrid<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"mtry"</span><span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                    verbose<span class="op">=</span><span class="cn">FALSE</span>,ntree<span class="op">=</span><span class="fl">50</span>,</span>
<span>                    trControl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span>,</span>
<span>                                           index <span class="op">=</span> <span class="va">indices</span><span class="op">$</span><span class="va">index</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ffsmodel_LLO</span></span></code></pre></div>
<pre><code><span><span class="co">## Selected Variables: </span></span>
<span><span class="co">## bio_1 bio_12 bio_6</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Random Forest </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 703 samples</span></span>
<span><span class="co">##   3 predictor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## No pre-processing</span></span>
<span><span class="co">## Resampling: Cross-Validated (10 fold) </span></span>
<span><span class="co">## Summary of sample sizes: 532, 244, 630 </span></span>
<span><span class="co">## Resampling results:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   RMSE      Rsquared   MAE     </span></span>
<span><span class="co">##   26.70724  0.4240436  17.70666</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Tuning parameter 'mtry' was held constant at a value of 2</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ffsmodel_LLO</span><span class="op">$</span><span class="va">selectedvars</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "bio_1"  "bio_12" "bio_6"</span></span></code></pre>
<p>Using the ffs with LLO CV, the R² could be increased from 0.36 to
0.42. The variables that are used for this model are “bio_1”,“bio_12”
and “bio_6”. All others are removed because they have (at least in this
small example) no spatial meaning or are even counterproductive.</p>
<p>By plotting the results of ffs, we can visualize how the performance
of the model changed depending on the variables being used:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ffsmodel_LLO</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-12-1.png" width="847.68"></p>
<p>See that the best model using two variables led to an R² of slightly
above 0.35. Using the third variable could slightly increase the R². Any
further variable could not improve the LLO performance. Note that the R²
features a high standard deviation regardless of the variables being
used. This is due to the small dataset that was used which cannot lead
to robust results.</p>
<p>What effect does the new model has on the spatial representation of
species richness?</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_ffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">predictors_sp</span>,<span class="va">ffsmodel_LLO</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction_ffs</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-13-1.png" width="847.68"></p>
</div>
<div class="section level2">
<h2 id="area-of-applicability">Area of Applicability<a class="anchor" aria-label="anchor" href="#area-of-applicability"></a>
</h2>
<p>Still it is required to analyse if the model can be applied to the
entire study area of if there are locations that are very different in
their predictor properties to what the model has learned from. See more
details in the vignette on the Area of applicability and <a href="https://doi.org/10.1111/2041-210X.13650" class="external-link">Meyer and Pebesma
2021</a>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### AOA for which the spatial CV error applies:</span></span>
<span><span class="va">AOA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span><span class="va">predictors_sp</span>,<span class="va">ffsmodel_LLO</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction_ffs</span>,main<span class="op">=</span><span class="st">"prediction for the AOA \n(spatial CV error applied)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA</span><span class="op">$</span><span class="va">AOA</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-14-1.png" width="847.68"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### AOA for which the random CV error applies:</span></span>
<span><span class="va">AOA_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span><span class="va">predictors_sp</span>,<span class="va">model</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prediction</span>,main<span class="op">=</span><span class="st">"prediction for the AOA \n(random CV error applied)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">AOA_random</span><span class="op">$</span><span class="va">AOA</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grey"</span>,<span class="st">"transparent"</span><span class="op">)</span>,add<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast01-CAST-intro-splot_files/figure-html/unnamed-chunk-14-2.png" width="847.68"></p>
<p>The figure shows in grey areas that are outside the area of
applicability, hence predictions should not be considered for these
locations. See tutorial on the AOA in this package for more
information.</p>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>To conclude, the tutorial has shown how CAST can be used to
facilitate target-oriented (here: spatial) CV on spatial and
spatio-temporal data which is crucial to obtain meaningful validation
results. Using the ffs in conjunction with target-oriented validation,
variables can be excluded that are counterproductive in view to the
target-oriented performance due to misinterpretations by the algorithm.
ffs therefore helps to select the ideal set of predictor variables for
spatio-temporal prediction tasks and gives objective error
estimates.</p>
</div>
<div class="section level2">
<h2 id="final-notes">Final notes<a class="anchor" aria-label="anchor" href="#final-notes"></a>
</h2>
<p>The intention of this tutorial is to describe the motivation that led
to the development of CAST as well as its functionality. Priority is not
on modelling species richness of Chile in the best possible way but to
provide an example for the motivation and functionality of CAST that can
run within a few minutes. Hence, only a very small subset of the entire
sPlotOpen dataset was used. Keep in mind that due to the small subset
the example is not robust and quite different results might be obtained
depending on small changes in the settings.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li><p>Meyer, H., &amp; Pebesma, E. (2022): Machine learning-based
global maps of ecological variables and the challenge of assessing them.
Nature Communications. Accepted.</p></li>
<li><p>Meyer, H., &amp; Pebesma, E. (2021). Predicting into unknown
space? Estimating the area of applicability of spatial prediction
models. Methods in Ecology and Evolution, 12, 1620– 1633. [<a href="https://doi.org/10.1111/2041-210X.13650" class="external-link uri">https://doi.org/10.1111/2041-210X.13650</a>]</p></li>
<li><p>Meyer H, Reudenbach C, Wöllauer S,Nauss T (2019) Importance of
spatial predictor variable selection in machine learning
applications–Moving from data reproduction to spatial prediction.
Ecological Modelling 411: 108815 [<a href="https://doi.org/10.1016/j.ecolmodel.2019.108815" class="external-link uri">https://doi.org/10.1016/j.ecolmodel.2019.108815</a>]</p></li>
<li><p>Meyer H, Reudenbach C, Hengl T, Katurij M, Nauss T (2018)
Improving performance of spatio-temporal machine learning models using
forward feature selection and target-oriented validation. Environmental
Modelling &amp; Software 101: 1–9 [<a href="https://doi.org/10.1016/j.envsoft.2017.12.001" class="external-link uri">https://doi.org/10.1016/j.envsoft.2017.12.001</a>]</p></li>
<li><p>Talk from the OpenGeoHub summer school 2019 on spatial validation
and variable selection: <a href="https://www.youtube.com/watch?v=mkHlmYEzsVQ" class="external-link uri">https://www.youtube.com/watch?v=mkHlmYEzsVQ</a>.</p></li>
<li><p>Tutorial (<a href="https://youtu.be/EyP04zLe9qo" class="external-link uri">https://youtu.be/EyP04zLe9qo</a>) and Lecture (<a href="https://youtu.be/OoNH6Nl-X2s" class="external-link uri">https://youtu.be/OoNH6Nl-X2s</a>) recording from OpenGeoHub
summer school 2020 on the area of applicability. As well as talk at the
OpenGeoHub summer school 2021: <a href="https://av.tib.eu/media/54879" class="external-link uri">https://av.tib.eu/media/54879</a></p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Hanna Meyer, Carles Milà, Marvin Ludwig, Jan Linnenbrink.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
