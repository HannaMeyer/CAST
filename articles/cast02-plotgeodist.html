<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CAST">
<title>2. Visualization of nearest neighbor distance distributions • CAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Visualization of nearest neighbor distance distributions">
<meta property="og:description" content="CAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cast01-CAST-intro.html">1. Introduction to CAST 1.0.0</a>
    <a class="dropdown-item" href="../articles/cast02-plotgeodist.html">2. Visualization of nearest neighbor distance distributions</a>
    <a class="dropdown-item" href="../articles/cast03-CV.html">3. Nearest neighbor distance matching Cross-validation in CAST</a>
    <a class="dropdown-item" href="../articles/cast04-AOA-tutorial.html">4. Area of applicability of spatial prediction models</a>
    <a class="dropdown-item" href="../articles/cast05-parallel.html">5. Improve computation time of CAST methods</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/HannaMeyer/CAST/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>2. Visualization of nearest neighbor distance distributions</h1>
                        <h4 data-toc-skip class="author">Hanna
Meyer</h4>
            
            <h4 data-toc-skip class="date">2024-06-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/HannaMeyer/CAST/blob/HEAD/vignettes/cast02-plotgeodist.Rmd" class="external-link"><code>vignettes/cast02-plotgeodist.Rmd</code></a></small>
      <div class="d-none name"><code>cast02-plotgeodist.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial shows how euclidean nearest neighbor distances in the
geographic space or feature space can be calculated and visualized using
CAST. This type of visualization allows to assess whether training data
feature a representative coverage of the prediction area and if
cross-validation (CV) folds (or independent test data) are adequately
chosen to be representative for the prediction locations.</p>
<p>See e.g. <a href="https://doi.org/10.1038/s41467-022-29838-9" class="external-link">Meyer
and Pebesma (2022)</a> and <a href="https://doi.org/10.1111/2041-210X.13851" class="external-link">Milà et al. (2022)</a>
for further discussion on this topic.</p>
</div>
<div class="section level2">
<h2 id="sample-data">Sample data<a class="anchor" aria-label="anchor" href="#sample-data"></a>
</h2>
<p>As example data, we use two different sets of global virtual
reference data: One is a spatial random sample and in the second
example, reference data are clustered in geographic space (see <a href="https://doi.org/10.1038/s41467-022-29838-9" class="external-link">Meyer and Pebesma
(2022)</a> for more discussions on this).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HannaMeyer/CAST" class="external-link">CAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geodata</span><span class="op">)</span></span></code></pre></div>
<p>Here we can define some parameters to run the example with different
settings</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># random realization</span></span>
<span><span class="va">samplesize</span> <span class="op">&lt;-</span> <span class="fl">250</span> <span class="co"># how many samples will be used?</span></span>
<span><span class="va">nparents</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co">#For clustered samples: How many clusters? </span></span>
<span><span class="va">radius</span> <span class="op">&lt;-</span> <span class="fl">500000</span> <span class="co"># For clustered samples: What is the radius of a cluster?</span></span></code></pre></div>
<div class="section level3">
<h3 id="prediction-area">Prediction area<a class="anchor" aria-label="anchor" href="#prediction-area"></a>
</h3>
<p>The prediction area is the entire global land area, i.e. we could
imagine a prediction task where we aim at making global predictions
based on the set of reference data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ee</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="st">"+proj=eqearth"</span><span class="op">)</span></span>
<span><span class="va">co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">co.ee</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">co</span>, <span class="va">ee</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="spatial-random-sample">Spatial random sample<a class="anchor" aria-label="anchor" href="#spatial-random-sample"></a>
</h3>
<p>Then, we simulate the random sample and visualize the data on the
entire global prediction area.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span><span class="va">pts_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">co.ee</span>, <span class="va">samplesize</span><span class="op">)</span></span>
<span><span class="co">### See points on the map:</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">co.ee</span>, fill<span class="op">=</span><span class="st">"#00BFC4"</span>,col<span class="op">=</span><span class="st">"#00BFC4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pts_random</span>, color <span class="op">=</span> <span class="st">"#F8766D"</span>,size<span class="op">=</span><span class="fl">0.5</span>, shape<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span>, col <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-4-1.png" width="595.2"></p>
</div>
<div class="section level3">
<h3 id="clustered-sample">Clustered sample<a class="anchor" aria-label="anchor" href="#clustered-sample"></a>
</h3>
<p>As second data set we use a clustered design of the same size.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pts_clustered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clustered_sample.html">clustered_sample</a></span><span class="op">(</span><span class="va">co.ee</span>, <span class="va">samplesize</span>, <span class="va">nparents</span>, <span class="va">radius</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">co.ee</span>, fill<span class="op">=</span><span class="st">"#00BFC4"</span>,col<span class="op">=</span><span class="st">"#00BFC4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pts_clustered</span>, color <span class="op">=</span> <span class="st">"#F8766D"</span>,size<span class="op">=</span><span class="fl">0.5</span>, shape<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span>, col <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-5-1.png" width="595.2"></p>
</div>
</div>
<div class="section level2">
<h2 id="distances-in-geographic-space">Distances in geographic space<a class="anchor" aria-label="anchor" href="#distances-in-geographic-space"></a>
</h2>
<p>Then we can plot the distributions of the spatial distances of
reference data to their nearest neighbor (“sample-to-sample”) with the
distribution of distances from all points of the global land surface to
the nearest reference data point (“sample-to-prediction”). Note that
samples of prediction locations are used to calculate the
sample-to-prediction nearest neighbor distances. Since we’re using a
global case study here, throughout this tutorial we use
sampling=Fibonacci to draw prediction locations with constant point
density on the sphere.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_random</span>,<span class="va">co.ee</span>,</span>
<span>                            sampling<span class="op">=</span><span class="st">"Fibonacci"</span><span class="op">)</span></span>
<span><span class="va">dist_clstr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_clustered</span>,<span class="va">co.ee</span>,</span>
<span>                           sampling<span class="op">=</span><span class="st">"Fibonacci"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_random</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Randomly distributed reference data"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-6-1.png" width="595.2"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_clstr</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Clustered reference data"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-6-2.png" width="595.2"></p>
<p>Note that for the random data set the nearest neighbor distance
distribution of the training data is quasi identical to the nearest
neighbor distance distribution of the prediction area. In comparison,
the second data set has the same number of training data but these are
heavily clustered in geographic space. We therefore see that the nearest
neighbor distances within the reference data is rather small. Prediction
locations, however, are on average much further away.</p>
<div class="section level3">
<h3 id="accounting-for-cross-validation-folds">Accounting for cross-validation folds<a class="anchor" aria-label="anchor" href="#accounting-for-cross-validation-folds"></a>
</h3>
<div class="section level4">
<h4 id="random-cross-validation">Random Cross-validation<a class="anchor" aria-label="anchor" href="#random-cross-validation"></a>
</h4>
<p>Let’s use the clustered data set to show how the distribution of
spatial nearest neighbor distances during cross-validation can be
visualized as well. Therefore, we first use the “default” way of a
random 10-fold cross validation where we randomly split the reference
data into training and test (see Meyer et al., 2018 and 2019 to see why
this might not be a good idea).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">randomfolds</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/createDataPartition.html" class="external-link">createFolds</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pts_clustered</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-8-1.png" width="595.2"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist_clstr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_clustered</span>,<span class="va">co.ee</span>,</span>
<span>                           sampling<span class="op">=</span><span class="st">"Fibonacci"</span>, </span>
<span>                           cvfolds<span class="op">=</span> <span class="va">randomfolds</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_clstr</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-9-1.png" width="595.2"></p>
<p>Obviously the CV folds are not representative for the prediction
locations (at least not in terms of distance to a nearest training data
point). I.e. when these folds are used for performance assessment of a
model, we can expect overly optimistic estimates because we only
validate predictions in close proximity to the reference data.</p>
</div>
<div class="section level4">
<h4 id="spatial-cross-validation">Spatial Cross-validation<a class="anchor" aria-label="anchor" href="#spatial-cross-validation"></a>
</h4>
<p>This, however, should not be the case but the CV performance should
be regarded as representative for the prediction task. Therefore, we use
a spatial CV instead. Here, we use a leave-cluster-out CV, which means
that in each iteration, one of the spatial clusters is held back.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spatialfolds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateSpacetimeFolds.html">CreateSpacetimeFolds</a></span><span class="op">(</span><span class="va">pts_clustered</span>,spacevar<span class="op">=</span><span class="st">"parent"</span>,k<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pts_clustered</span><span class="op">$</span><span class="va">parent</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-11-1.png" width="595.2"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist_clstr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_clustered</span>,<span class="va">co.ee</span>,</span>
<span>                           sampling<span class="op">=</span><span class="st">"Fibonacci"</span>,</span>
<span>                           cvfolds<span class="op">=</span> <span class="va">spatialfolds</span><span class="op">$</span><span class="va">indexOut</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_clstr</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-12-1.png" width="595.2"></p>
<p>See that this fits the nearest neighbor distribution of the
prediction area much better. Note that <code>geodist</code> also allows
inspecting independent test data instead of cross validation folds. See
<code><a href="../reference/geodist.html">?geodist</a></code> and <code><a href="../reference/plot.html">?plot.geodist</a></code>.</p>
</div>
<div class="section level4">
<h4 id="why-has-spatial-cv-sometimes-blamed-for-being-too-pessimistic">Why has spatial CV sometimes blamed for being too pessimistic ?<a class="anchor" aria-label="anchor" href="#why-has-spatial-cv-sometimes-blamed-for-being-too-pessimistic"></a>
</h4>
<p>Recently, <a href="https://doi.org/10.1016/j.ecolmodel.2021.109692" class="external-link">Wadoux et
al. (2021)</a> published a paper with the title “Spatial
cross-validation is not the right way to evaluate map accuracy” where
they state that “spatial cross-validation strategies resulted in a
grossly pessimistic map accuracy assessment”. Why do they come to this
conclusion? The reference data they used in their study where either
regularly, random or comparably mildly clustered in geographic space,
but they applied spatial CV strategies that held large spatial units
back during CV. Here we can see what happens when we apply spatial CV to
randomly distributed reference data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a spatial CV for the randomly distributed data. Here:</span></span>
<span><span class="co"># "leave region-out-CV"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pts_random_co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">pts_random</span><span class="op">)</span>,<span class="va">co.ee</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">co.ee</span>, fill<span class="op">=</span><span class="st">"#00BFC4"</span>,col<span class="op">=</span><span class="st">"#00BFC4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pts_random_co</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">subregion</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">0.5</span>, shape<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pts_random_co</span><span class="op">$</span><span class="va">subregion</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"spatial fold membership by color"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-13-1.png" width="595.2"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spfolds_rand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateSpacetimeFolds.html">CreateSpacetimeFolds</a></span><span class="op">(</span><span class="va">pts_random_co</span>,spacevar <span class="op">=</span> <span class="st">"subregion"</span>,</span>
<span>                                     k<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pts_random_co</span><span class="op">$</span><span class="va">subregion</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dist_rand_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_random_co</span>,<span class="va">co.ee</span>,</span>
<span>                             sampling<span class="op">=</span><span class="st">"Fibonacci"</span>, </span>
<span>                             cvfolds<span class="op">=</span> <span class="va">spfolds_rand</span><span class="op">$</span><span class="va">indexOut</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_rand_sp</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-14-1.png" width="595.2"></p>
<p>We see that the nearest neighbor distances during cross-validation
don’t match the nearest neighbor distances during prediction. But
compared to the section above, this time the cross-validation folds are
too far away from reference data. Naturally we would end up with overly
pessimistic performance estimates because we make prediction situations
during cross-validation harder, compared to what is required during
model application to the entire area of interest (here global). The
spatial CV chosen here is therefore not suitable for this prediction
task, because prediction situations created during CV do not resemble
what is encountered during prediction.</p>
</div>
<div class="section level4">
<h4 id="nearest-neighbour-distance-matching-cv">Nearest Neighbour Distance Matching CV<a class="anchor" aria-label="anchor" href="#nearest-neighbour-distance-matching-cv"></a>
</h4>
<p>A good way to approximate the geographical prediction distances
during the CV is to use Nearest Neighbour Distance Matching (NNDM) CV
(see <a href="https://doi.org/10.1111/2041-210X.13851" class="external-link">Milà et al.,
2022</a> for more details). NNDM CV is a variation of LOO CV in which
the empirical distribution function of nearest neighbour distances found
during prediction is matched during the CV process. Since NNDM CV is
highly time consuming, the k-fold version may provide a good trade-off.
See (see <a href="https://doi.org/10.5194/egusphere-2023-1308" class="external-link">Linnenbrink et al.,
2023</a> for more details on knndm)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nndmfolds_clstr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knndm.html">knndm</a></span><span class="op">(</span><span class="va">pts_clustered</span>, modeldomain<span class="op">=</span><span class="va">co.ee</span>, samplesize <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">dist_clstr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_clustered</span>,<span class="va">co.ee</span>,</span>
<span>                           sampling <span class="op">=</span> <span class="st">"Fibonacci"</span>,</span>
<span>                           cvfolds <span class="op">=</span> <span class="va">nndmfolds_clstr</span><span class="op">$</span><span class="va">indx_test</span>, </span>
<span>                           cvtrain <span class="op">=</span> <span class="va">nndmfolds_clstr</span><span class="op">$</span><span class="va">indx_train</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_clstr</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-15-1.png" width="595.2"></p>
<p>The NNDM CV-distance distribution matches the sample-to-prediction
distribution very well. What happens if we use NNDM CV for the
randomly-distributed sampling points instead?</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nndmfolds_rand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knndm.html">knndm</a></span><span class="op">(</span><span class="va">pts_random_co</span>,  modeldomain<span class="op">=</span><span class="va">co.ee</span>, samplesize <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">dist_rand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_random_co</span>,<span class="va">co.ee</span>,</span>
<span>                          sampling <span class="op">=</span> <span class="st">"Fibonacci"</span>,</span>
<span>                          cvfolds <span class="op">=</span> <span class="va">nndmfolds_rand</span><span class="op">$</span><span class="va">indx_test</span>, </span>
<span>                          cvtrain <span class="op">=</span> <span class="va">nndmfolds_rand</span><span class="op">$</span><span class="va">indx_train</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_rand</span>, unit <span class="op">=</span> <span class="st">"km"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span>labels<span class="op">=</span><span class="va">round</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-16-1.png" width="595.2"></p>
<p>The NNDM CV-distance still matches the sample-to-prediction distance
function.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="distances-in-feature-space">Distances in feature space<a class="anchor" aria-label="anchor" href="#distances-in-feature-space"></a>
</h2>
<p>So far we compared nearest neighbor distances in geographic space. We
can also do so in feature space. Therefore, a set of bioclimatic
variables are used (<a href="https://www.worldclim.org" class="external-link uri">https://www.worldclim.org</a>) as features (i.e. predictors)
in this virtual prediction task.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictors_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geodata/man/worldclim.html" class="external-link">worldclim_global</a></span><span class="op">(</span>var<span class="op">=</span><span class="st">"bio"</span>,res <span class="op">=</span> <span class="fl">10</span>,path<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors_global</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bio_"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">19</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">predictors_global</span> <span class="op">&lt;-</span> <span class="va">predictors_global</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bio_2"</span>, <span class="st">"bio_10"</span>, <span class="st">"bio_13"</span>, <span class="st">"bio_19"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">predictors_global</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-17-1.png" width="595.2"></p>
<p>Then we visualize nearest neighbor feature space distances under
consideration of cross-validation.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use random CV:</span></span>
<span><span class="va">dist_clstr_rCV</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_clustered</span>,<span class="va">predictors_global</span>,</span>
<span>                               type <span class="op">=</span> <span class="st">"feature"</span>, </span>
<span>                               sampling<span class="op">=</span><span class="st">"Fibonacci"</span>,</span>
<span>                               cvfolds <span class="op">=</span> <span class="va">randomfolds</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use spatial CV:</span></span>
<span><span class="va">dist_clstr_sCV</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geodist.html">geodist</a></span><span class="op">(</span><span class="va">pts_clustered</span>,<span class="va">predictors_global</span>,</span>
<span>                               type <span class="op">=</span> <span class="st">"feature"</span>, sampling<span class="op">=</span><span class="st">"Fibonacci"</span>,</span>
<span>                               cvfolds <span class="op">=</span> <span class="va">spatialfolds</span><span class="op">$</span><span class="va">indexOut</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Plot results:</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_clstr_rCV</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Clustered reference data and random CV"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-18-1.png" width="595.2"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">dist_clstr_sCV</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Clustered reference data and spatial CV"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast02-plotgeodist_files/figure-html/unnamed-chunk-18-2.png" width="595.2"></p>
<p>With regard to the chosen predictor variables we see that again the
nearest neighbor distance of the clustered training data is rather
small, compared to what is required during prediction. Again the random
CV is not representative for the prediction locations while spatial CV
is doing a better job.</p>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<ul>
<li>Meyer, H., Pebesma, E. (2022): Machine learning-based global maps of
ecological variables and the challenge of assessing them. Nature
Communications 13, 2208. <a href="https://doi.org/10.1038/s41467-022-29838-9" class="external-link uri">https://doi.org/10.1038/s41467-022-29838-9</a>
</li>
<li>Milà, C., Mateu, J., Pebesma, E., Meyer, H. (2022): Nearest
Neighbour Distance Matching Leave-One-Out Cross-Validation for map
validation. Methods in Ecology and Evolution 00, 1– 13. <a href="https://doi.org/10.1111/2041-210X.13851" class="external-link uri">https://doi.org/10.1111/2041-210X.13851</a>.</li>
<li>Linnenbrink, J., Milà, C., Ludwig, M., and Meyer, H. (2023): kNNDM:
k-fold Nearest Neighbour Distance Matching Cross-Validation for map
accuracy estimation, EGUsphere [preprint], <a href="https://doi.org/10.5194/egusphere-2023-1308" class="external-link uri">https://doi.org/10.5194/egusphere-2023-1308</a>.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hanna Meyer, Carles Milà, Marvin Ludwig, Jan Linnenbrink, Fabian Schumacher.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
