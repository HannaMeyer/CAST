<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CAST">
<title>5. Improve computation time of CAST methods • CAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="5. Improve computation time of CAST methods">
<meta property="og:description" content="CAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cast01-CAST-intro.html">1. Introduction to CAST 1.0.0</a>
    <a class="dropdown-item" href="../articles/cast02-plotgeodist.html">2. Visualization of nearest neighbor distance distributions</a>
    <a class="dropdown-item" href="../articles/cast03-CV.html">3. Nearest neighbor distance matching Cross-validation in CAST</a>
    <a class="dropdown-item" href="../articles/cast04-AOA-tutorial.html">4. Area of applicability of spatial prediction models</a>
    <a class="dropdown-item" href="../articles/cast05-parallel.html">5. Improve computation time of CAST methods</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/HannaMeyer/CAST/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>5. Improve computation time of CAST methods</h1>
                        <h4 data-toc-skip class="author">Marvin
Ludwig</h4>
            
            <h4 data-toc-skip class="date">2024-06-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/HannaMeyer/CAST/blob/HEAD/vignettes/cast05-parallel.Rmd" class="external-link"><code>vignettes/cast05-parallel.Rmd</code></a></small>
      <div class="d-none name"><code>cast05-parallel.Rmd</code></div>
    </div>

    
    
<p>Working with machine learning methods and spatial data can be
computationally expensive. Especially for larger scale applications like
<a href="https://doi.org/10.1111/geb.13635" class="external-link">global maps (Ludwig et. al
2024)</a> or high resolution data (e.g. from drones) computation times
of CAST methods can be quite long. This vignette goes over various
options for efficient spatial modelling workflows and parallelization
options in order to speed up computation times of CAST methods.</p>
<div class="section level2">
<h2 id="forward-feature-selection">Forward feature selection<a class="anchor" aria-label="anchor" href="#forward-feature-selection"></a>
</h2>
<p>As the forward feature selection basically is a brute force grid
search of the best predictor variable combination, during
<code>ffs</code> a large number of machine learning models are trained
to compare their performance. These model trainings can be run in
parallel. On Unix machines, this is implemented using
<code>mclapply</code> from the <code>parallel-package</code>. Simply set
the <code>cores</code> argument to a value <code>&gt; 1</code> to use
multiple cores for the model training. On windows machines, you will get
the warning
<code>Parallel computations of ffs only implemented on unix systems. cores is set to 1</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"splotdata"</span><span class="op">)</span></span>
<span><span class="va">spatial_cv</span> <span class="op">=</span> <span class="fu"><a href="../reference/CreateSpacetimeFolds.html">CreateSpacetimeFolds</a></span><span class="op">(</span><span class="va">splotdata</span>, spacevar <span class="op">=</span> <span class="st">"Biome"</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span>,index <span class="op">=</span> <span class="va">spatial_cv</span><span class="op">$</span><span class="va">index</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ffsmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs.html">ffs</a></span><span class="op">(</span>predictors <span class="op">=</span> <span class="va">splotdata</span><span class="op">[</span>,<span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">]</span>,</span>
<span>                response <span class="op">=</span> <span class="va">splotdata</span><span class="op">$</span><span class="va">Species_richness</span>,</span>
<span>                tuneLength <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                method <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>                trControl <span class="op">=</span> <span class="va">ctrl</span>,</span>
<span>                ntree <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>Regardless of the system, you can speed up the model training in
<code>ffs</code>, as <code><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">caret::train</a></code> has a <a href="https://topepo.github.io/caret/parallel-processing.html" class="external-link">parallelization
option</a> that trains models on multiple cores. The code below is
adapated from <a href="https://topepo.github.io/caret/parallel-processing.html" class="external-link">https://topepo.github.io/caret/parallel-processing</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"splotdata"</span><span class="op">)</span></span>
<span><span class="va">spatial_cv</span> <span class="op">=</span> <span class="fu"><a href="../reference/CreateSpacetimeFolds.html">CreateSpacetimeFolds</a></span><span class="op">(</span><span class="va">splotdata</span>, spacevar <span class="op">=</span> <span class="st">"Biome"</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span>,index <span class="op">=</span> <span class="va">spatial_cv</span><span class="op">$</span><span class="va">index</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="va">ffsmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs.html">ffs</a></span><span class="op">(</span>predictors <span class="op">=</span> <span class="va">splotdata</span><span class="op">[</span>,<span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">]</span>,</span>
<span>                response <span class="op">=</span> <span class="va">splotdata</span><span class="op">$</span><span class="va">Species_richness</span>,</span>
<span>                tuneLength <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                method <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>                trControl <span class="op">=</span> <span class="va">ctrl</span>,</span>
<span>                ntree <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Another option is the use of a different model algorithm. For
example, the <code>ranger</code> package is a fast and multicore
implementation of the random forest model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ffsmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffs.html">ffs</a></span><span class="op">(</span>predictors <span class="op">=</span> <span class="va">splotdata</span><span class="op">[</span>,<span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">]</span>,</span>
<span>                response <span class="op">=</span> <span class="va">splotdata</span><span class="op">$</span><span class="va">Species_richness</span>,</span>
<span>                method <span class="op">=</span> <span class="st">"ranger"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="area-of-applicability">Area of applicability<a class="anchor" aria-label="anchor" href="#area-of-applicability"></a>
</h2>
<p>Estimating the Area of Applicability (AOA) can be computationally
expansive as the method is based on finding minimum distances and
nearest neighbors. We can divide the computation into three major
chunks:</p>
<ol style="list-style-type: decimal">
<li>The feature space distance between all training data.</li>
<li>The nearest feature space distance between training data in
different CV folds.</li>
<li>The distance between new locations (pixel) and the nearest training
data in feature space.</li>
</ol>
<p>(1.) and (2.) are needed to derive the AOA threshold and solely based
on the training data and cross validation configuration. They are
computed together in the <code>trainDI</code> function. (3.) is needed
to calculate the dissimilarity index of the predictor stack in the
<code>aoa</code> function. Under the hood, the <code>aoa</code> function
calls <code>trainDI</code> as it’s first step and then calculates the DI
of the predictor stack.</p>
<p>You can speed up computation times of <code>aoa</code> by splitting
these two processes and calculate the DI on multiple raster tiles at
once.</p>
<div class="section level3">
<h3 id="traindi">trainDI<a class="anchor" aria-label="anchor" href="#traindi"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HannaMeyer/CAST" class="external-link">CAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/" class="external-link">caret</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"splotdata"</span><span class="op">)</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,<span class="st">"predictors_chile.tif"</span>,package<span class="op">=</span><span class="st">"CAST"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">splotdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span><span class="va">splotdata</span><span class="op">[</span>,<span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">]</span>,</span>
<span>               <span class="va">splotdata</span><span class="op">$</span><span class="va">Species_richness</span>,</span>
<span>               method<span class="op">=</span><span class="st">"rf"</span>,</span>
<span>               tuneLength <span class="op">=</span> <span class="fl">1</span>,</span>
<span>               importance<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>               ntrees <span class="op">=</span> <span class="fl">20</span>,</span>
<span>               trControl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"cv"</span><span class="op">)</span>, number <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="va">model</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Calling <code>trainDI</code> just needs the model object, as this
also contains the training data, cross-validation information and
variable importance. The result of <code>trainDI</code> then contains
all the necessary information from the training data and model that the
<code>aoa</code> function needs to compute the DI for new locations.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tdi</span> <span class="op">=</span> <span class="fu"><a href="../reference/trainDI.html">trainDI</a></span><span class="op">(</span><span class="va">model</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">tdi</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DI of 703 observation </span></span>
<span><span class="co">## Predictors: bio_1 bio_4 bio_5 bio_6 bio_8 bio_9 bio_12 bio_13 bio_14 bio_15 elev </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## AOA Threshold: 0.1903705</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">tdi</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "trainDI"</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">tdi</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 10</span></span>
<span><span class="co">##  $ train             :'data.frame':  703 obs. of  11 variables:</span></span>
<span><span class="co">##   ..$ bio_1 : num [1:703] 17.6 17.4 18.3 18 18.8 ...</span></span>
<span><span class="co">##   ..$ bio_4 : num [1:703] 464 460 473 486 478 ...</span></span>
<span><span class="co">##   ..$ bio_5 : num [1:703] 30.5 30.1 31.4 31.2 32 ...</span></span>
<span><span class="co">##   ..$ bio_6 : num [1:703] 3.6 3.5 4.2 4.2 4.4 ...</span></span>
<span><span class="co">##   ..$ bio_8 : num [1:703] 23.2 22.9 24 23.9 24.5 ...</span></span>
<span><span class="co">##   ..$ bio_9 : num [1:703] 11.7 11.5 12.2 11.8 12.6 ...</span></span>
<span><span class="co">##   ..$ bio_12: num [1:703] 760 731 810 842 853 842 823 525 524 554 ...</span></span>
<span><span class="co">##   ..$ bio_13: num [1:703] 119 115 129 140 134 133 129 92 90 90 ...</span></span>
<span><span class="co">##   ..$ bio_14: num [1:703] 9 9 12 13 12 12 12 7 6 5 ...</span></span>
<span><span class="co">##   ..$ bio_15: num [1:703] 68.9 68.9 66.9 65.5 68.3 ...</span></span>
<span><span class="co">##   ..$ elev  : num [1:703] 416 468 232 129 231 243 193 188 261 468 ...</span></span>
<span><span class="co">##  $ weight            :'data.frame':  1 obs. of  11 variables:</span></span>
<span><span class="co">##   ..$ bio_1 : num 20.4</span></span>
<span><span class="co">##   ..$ bio_4 : num 20.3</span></span>
<span><span class="co">##   ..$ bio_5 : num 14.6</span></span>
<span><span class="co">##   ..$ bio_6 : num 22.6</span></span>
<span><span class="co">##   ..$ bio_8 : num 18.5</span></span>
<span><span class="co">##   ..$ bio_9 : num 15.1</span></span>
<span><span class="co">##   ..$ bio_12: num 25.9</span></span>
<span><span class="co">##   ..$ bio_13: num 17.3</span></span>
<span><span class="co">##   ..$ bio_14: num 18.6</span></span>
<span><span class="co">##   ..$ bio_15: num 18.2</span></span>
<span><span class="co">##   ..$ elev  : num 14.3</span></span>
<span><span class="co">##  $ variables         : chr [1:11] "bio_1" "bio_4" "bio_5" "bio_6" ...</span></span>
<span><span class="co">##  $ catvars           : chr(0) </span></span>
<span><span class="co">##  $ scaleparam        :List of 4</span></span>
<span><span class="co">##   ..$ dim          : int [1:2] 703 11</span></span>
<span><span class="co">##   ..$ dimnames     :List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:703] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:11] "bio_1" "bio_4" "bio_5" "bio_6" ...</span></span>
<span><span class="co">##   ..$ scaled:center: Named num [1:11] 14.26 171.83 21.77 6.71 14.4 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "names")= chr [1:11] "bio_1" "bio_4" "bio_5" "bio_6" ...</span></span>
<span><span class="co">##   ..$ scaled:scale : Named num [1:11] 7.27 156.2 8.2 6.67 8.28 ...</span></span>
<span><span class="co">##   .. ..- attr(*, "names")= chr [1:11] "bio_1" "bio_4" "bio_5" "bio_6" ...</span></span>
<span><span class="co">##  $ trainDist_avrg    : num [1:703] 87.2 87.2 87.1 86.9 87.6 ...</span></span>
<span><span class="co">##  $ trainDist_avrgmean: num 81.5</span></span>
<span><span class="co">##  $ trainDI           : num [1:703] 0.0222 0.0173 0.0258 0.0409 0.0115 ...</span></span>
<span><span class="co">##  $ threshold         : Named num 0.19</span></span>
<span><span class="co">##   ..- attr(*, "names")= chr "75%"</span></span>
<span><span class="co">##  $ method            : chr "L2"</span></span>
<span><span class="co">##  - attr(*, "class")= chr "trainDI"</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># you can save the trainDI object for later application</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">tdi</span>, <span class="st">"path/to/file"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aoa-for-multiple-rasters">AOA for multiple rasters<a class="anchor" aria-label="anchor" href="#aoa-for-multiple-rasters"></a>
</h3>
<p>If you have a very large area of interest for which you want to
derive the Area of Applicability, computing the AOA for the entire area
at once might not be possible or takes a very long time. You can use a
tile based approach to apply the <code>trainDI</code> object from the
previous step to multiple rasters at once.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r1</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">75.66667</span>, <span class="op">-</span><span class="fl">67</span>, <span class="op">-</span><span class="fl">30</span>, <span class="op">-</span><span class="fl">17.58333</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">75.66667</span>, <span class="op">-</span><span class="fl">67</span>, <span class="op">-</span><span class="fl">45</span>, <span class="op">-</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r3</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">75.66667</span>, <span class="op">-</span><span class="fl">67</span>, <span class="op">-</span><span class="fl">55.58333</span>, <span class="op">-</span><span class="fl">45</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,main <span class="op">=</span> <span class="st">"Tile 1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,main <span class="op">=</span> <span class="st">"Tile 2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r3</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,main <span class="op">=</span> <span class="st">"Tile 3"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast05-parallel_files/figure-html/unnamed-chunk-5-1.png" width="30%"><img src="cast05-parallel_files/figure-html/unnamed-chunk-5-2.png" width="30%"><img src="cast05-parallel_files/figure-html/unnamed-chunk-5-3.png" width="30%"></p>
<p>Use the <code>trainDI</code> argument in the <code>aoa</code>
function to specify, that you want to use a previously computed trainDI
object.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoa_r1</span> <span class="op">=</span> <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">r1</span>, trainDI <span class="op">=</span> <span class="va">tdi</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Tile 1: Predictors"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">aoa_r1</span><span class="op">$</span><span class="va">DI</span>, main <span class="op">=</span> <span class="st">"Tile 1: DI"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">aoa_r1</span><span class="op">$</span><span class="va">AOA</span>, main <span class="op">=</span> <span class="st">"Tile 1: AOA"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast05-parallel_files/figure-html/unnamed-chunk-6-1.png" width="30%"><img src="cast05-parallel_files/figure-html/unnamed-chunk-6-2.png" width="30%"><img src="cast05-parallel_files/figure-html/unnamed-chunk-6-3.png" width="30%"></p>
<p>You can now run the aoa function in parallel on the different tiles!
Of course you can use for favorite parallel backend for this task, here
we use mclapply from the <code>parallel</code> package.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiles_aoa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span>, <span class="va">r3</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tile</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">tile</span>, trainDI <span class="op">=</span> <span class="va">tdi</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">tiles_aoa</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">AOA</span>, main <span class="op">=</span> <span class="st">"Tile 1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">tiles_aoa</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">AOA</span>, main <span class="op">=</span> <span class="st">"Tile 2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">tiles_aoa</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">AOA</span>, main <span class="op">=</span> <span class="st">"Tile 3"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cast05-parallel_files/figure-html/unnamed-chunk-9-1.png" width="30%"><img src="cast05-parallel_files/figure-html/unnamed-chunk-9-2.png" width="30%"><img src="cast05-parallel_files/figure-html/unnamed-chunk-9-3.png" width="30%"></p>
<p>For even larger tasks it might be useful to save the tiles to you
hard-drive and load them one by one to avoid filling up your RAM.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simple Example Code for raster tiles on the hard drive</span></span>
<span></span>
<span><span class="va">tiles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"path/to/tiles"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tiles_aoa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="va">tiles</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tile</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">current</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">tile</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/aoa.html">aoa</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">current</span>, trainDI <span class="op">=</span> <span class="va">model_random_trainDI</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hanna Meyer, Carles Milà, Marvin Ludwig, Jan Linnenbrink, Fabian Schumacher.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
