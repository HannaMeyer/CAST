---
title: "AOA Code Improvements"
author: "Marvin Ludwig"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    theme: united
vignette: >
  %\VignetteIndexEntry{CAST - Code updates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r, message = FALSE, warning=FALSE}
library(CAST)
library(virtualspecies)
library(caret)
library(raster)
library(sp)
library(sf)
library(viridis)
library(latticeExtra)
library(gridExtra)
```


This vignette goes over recent changes (November 2021) of the Area of Applicability (AOA). The main change is the split of the AOA function in `trainDI` and `aoa`. This was mainly done for easier future developments and parallel computations.



# Example Data

Using the same setup as AOA Tutorial. Look there for details.


```{r, message = FALSE, warning=FALSE}
predictors <- stack(system.file("extdata","bioclim.grd",package="CAST"))
response <- generateSpFromPCA(predictors,
                              means = c(3,1),sds = c(2,2), plot=F)$suitab.raster


# Simulating sampling locations
mask <- predictors[[1]]
values(mask)[!is.na(values(mask))] <- 1
mask <- rasterToPolygons(mask)
set.seed(15)
samplepoints <- spsample(mask,20,"random")


# Generate Training Data
trainDat <- extract(predictors,samplepoints,df=TRUE)
trainDat$response <- extract (response,samplepoints)
trainDat <- trainDat[complete.cases(trainDat),]

# Train the model
set.seed(10)
model <- train(trainDat[,names(predictors)],
               trainDat$response,
               method="rf",
               importance=TRUE,
               trControl = trainControl(method="cv"))
```



## AOA Calculation

The aoa function works out of the box like previously, however the structure of the output changed slightly. The function now returns an object of class `aoa` which is just a list with two entries: 1. object of class `trainDI` and 2. the output raster or data.frame with the actual AOA results.

```{r,message = FALSE, warning=FALSE}
AOA <- aoa(predictors, model)
class(AOA)
names(AOA)
```


## TrainDI

The first list entry of the aoa output is the result of the new function `trainDI`. This function computes the Dissimilarity Index (DI) of the data used for model training which is needed for the DI threshold used for the AOA estimation. Since this threshold is only dependent on the training data it can be computed from the model alone and reused for different predictions later on. In addition, there are now generic functions for plotting and printing the DI.


```{r, message = FALSE, warning = FALSE}
DI = trainDI(model)
class(DI)
str(DI)
print(DI)
plot(DI)
```

Once the trainDI is computed, it can be reused for multiple predictions. This makes it much easier and faster to e.g. compute the AOA for multiple raster tiles in parallel. In addition the aoa also has a generic plotting function, displaying the distribution of the DIs from the training and prediction data.

```{r}
DI = trainDI(model)
aoa1 = aoa(newdata = predictors, model = model, trainDI = DI)
plot(aoa1)
```



